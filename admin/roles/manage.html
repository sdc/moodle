<?php  //$Id$

    switch ($action) {
        case 'add':
            $submitlabel = get_string('addrole', 'role');
            break;
        case 'view':
            $submitlabel = get_string('listallroles', 'role');
            break;
        case 'edit':
        default:
            $submitlabel = get_string('savechanges');
    }
?>


<form name="rolesform" action="manage.php" method="post">
<input type="hidden" name="roleid" value="<?php p($roleid) ?>" />
<input type="hidden" name="sesskey" value="<?php p(sesskey()) ?>" />
<input type="hidden" name="action" value="<?php if ($action != 'view') { echo p($action); } ?>" />

<table cellpadding="9" cellspacing="0" align="center">
<tr valign="top">
    <td align="right"><?php print_string('name') ?>:</td>
    <td><?php
    if ($action == 'view') {
        p($role->name);
    } else {
        echo '<input type="text" name="name" maxlength="254" size="50" value="'.s($role->name).'" />';
        if (isset($errors["name"])) formerr($errors["name"]);
    } ?></td>
</tr>
<tr valign="top">
    <td align="right"><?php print_string('shortname') ?>:</td>
    <td><?php
    if ($action == 'view') {
        p($role->shortname);
    } else {
        echo '<input type="text" name="shortname" maxlength="20" size="15" value="'.s($role->shortname).'" />';
        if (isset($errors["shortname"])) formerr($errors["shortname"]);
    } ?></td>
</tr>
<tr valign="top">
    <td align="right"><?php print_string('description') ?>:</td>
    <td><?php
    if ($action == 'view') {
        p($role->description);
        $usehtmleditor = false;
    } else {
        print_textarea($usehtmleditor, 10, 50, 50, 10, 'description', $role->description);
    } ?></td>
</tr>
</table>

<?php 
    print_heading(get_string('permissions','role'));

    $strinherit = get_string('inherit','role');
    $strallow = get_string('allow','role');
    $strprevent = get_string('prevent','role');
    $strprohibit = get_string('prohibit','role');
?>

<table class="rolecap" align="center">

<tr>
<th class="name" align="left"><?php print_string('capability','role') ?></th>
<th class="inherit"><?php p($strinherit); ?></th>
<th class="allow"><?php p($strallow); ?></th>
<th class="prevent"><?php p($strprevent); ?></th>
<th class="prohibit"><?php p($strprohibit); ?></th>
<th class="risk"><?php print_string('risks','role') ?></th>
</tr>

<?php

// init these 2
$contextlevel = 0;
$component = '';

foreach ($capabilities as $capability) {
    // prints a breaker if component or name or context level
    if ($capability->component != $component or $capability->contextlevel != $contextlevel) {
        echo ('<tr class="rolecapheading header"><td colspan="6" class="header"><strong>'.
               get_component_string($capability->component, $capability->contextlevel).'</strong></td></tr>');
    }

    // these 2 are used to see to group same mod/core capabilities together
    $contextlevel = $capability->contextlevel;
    $component = $capability->component;

    if (empty($errors)) {
       // check the capability override for this cap, this role in this context
        $sitecontext = get_context_instance(CONTEXT_SYSTEM, SITEID);
        $localoverride = get_local_override($roleid, $sitecontext->id, $capability->name);
    } else {
        $localoverride = new object();
        $localoverride->permission = $role->{$capability->name};
    }

    $disabled = ($action != 'edit') ? ' disabled="disabled" ' : '';

    $riskinfo = '';
    $rowclasses = '';
    if (RISK_MANAGETRUST & (int)$capability->riskbitmask) {
        $riskinfo .= '<a title="'.get_string('riskmanagetrust', 'admin').'" href="'.$CFG->docroot.'/'.$lang.'/Risks">T</a>';
        $rowclasses .= ' riskmanagetrust';
    }
    if (RISK_CONFIG & (int)$capability->riskbitmask) {
        $riskinfo .= '<a title="'.get_string('riskconfig', 'admin').'" href="'.$CFG->docroot.'/'.$lang.'/Risks">C</a>';
        $rowclasses .= ' riskconfig';
    }
    if (RISK_XSS & (int)$capability->riskbitmask) {
        $riskinfo .= '<a title="'.get_string('riskxss', 'admin').'" href="'.$CFG->docroot.'/'.$lang.'/Risks">X</a>';
        $rowclasses .= ' riskxss';
    }
    if (RISK_PERSONAL & (int)$capability->riskbitmask) {
        $riskinfo .= '<a title="'.get_string('riskpersonal', 'admin').'" href="'.$CFG->docroot.'/'.$lang.'/Risks">P</a>';
        $rowclasses .= ' riskpersonal';
    }
    if (RISK_SPAM & (int)$capability->riskbitmask) {
        $riskinfo .= '<a title="'.get_string('riskspam', 'admin').'" href="'.$CFG->docroot.'/'.$lang.'/Risks">S</a>';
        $rowclasses .= ' riskspam';
    }

    ?>

        <tr class="rolecap <?php echo $rowclasses; ?>">
        <td class="name"><span title="<?php echo $capability->name ?>"><?php echo get_capability_string($capability->name); ?></span></td>
        <td class="inherit"><input type="radio" title="<?php p($strinherit); ?>" name="<?php echo $capability->name; ?>" value="<?php echo CAP_INHERIT ?>" <?php if (!isset($localoverride->permission) || $localoverride->permission==CAP_INHERIT){ echo 'checked="checked"'; }?> <?php echo $disabled; ?>/></td>
        <td class="allow"><input type="radio" title="<?php p($strallow); ?>" name="<?php echo $capability->name; ?>" value="<?php echo CAP_ALLOW ?>" <?php if (isset($localoverride->permission) && $localoverride->permission==CAP_ALLOW){ echo 'checked="checked"'; }?> <?php echo $disabled; ?>/></td>
        <td class="prevent" ><input type="radio" title="<?php p($strprevent); ?>" name="<?php echo $capability->name; ?>" value="<?php echo CAP_PREVENT ?>" <?php if (isset($localoverride->permission) && $localoverride->permission==CAP_PREVENT){ echo 'checked="checked"'; }?> <?php echo $disabled; ?>/></td>
        <td class="prohibit" ><input type="radio" title="<?php p($strprohibit); ?>" name="<?php echo $capability->name; ?>" value="<?php echo CAP_PROHIBIT ?>" <?php if (isset($localoverride->permission) && $localoverride->permission==CAP_PROHIBIT){ echo 'checked="checked"'; }?> <?php echo $disabled; ?>/></td>
        <td class="risk"><?php 
            echo $riskinfo; 
        ?></td>
        </tr>

<?php } ?>
</table>

<div class="submit" align="center">
<input type="submit" value="<?php p($submitlabel) ?>" />
<?php if ($action != 'view') { ?>
<input type="submit" name="cancel" value="<?php print_string('cancel') ?>" />
<?php } ?>
</div>

</form>
