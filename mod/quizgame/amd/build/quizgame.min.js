define(["jquery"],function(a){function b(a){if(document.getElementById("mod_quizgame_sound_on").checked){var b=document.getElementById("mod_quizgame_sound_"+a);b.currentTime=0,b.play()}}function c(){S.removeAttribute("width"),S.removeAttribute("height"),S.removeAttribute("style"),ea.width=S.clientWidth,ea.height=S.clientHeight,S.style.width=ea.width,S.style.height=ea.height,f(S)}function d(){la--,1>la&&c()}function e(){ea.width=window.screen.width||S.clientWidth,ea.height=window.screen.height||S.clientHeight,S.requestFullscreen?S.requestFullscreen():S.msRequestFullscreen?S.msRequestFullscreen():S.mozRequestFullScreen?S.mozRequestFullScreen():S.webkitRequestFullscreen&&S.webkitRequestFullscreen(),la=2,S.style.width=screen.width+"px",S.style.height="100%",f(S)}function f(a){a.width=ea.width,a.height=ea.height,X.imageSmoothingEnabled=!1}function g(){document.onkeydown=null,document.onkeyup=null,document.onmousedown=null,document.onmouseup=null,document.onmousemove=null,document.ontouchstart=null,document.ontouchend=null,document.ontouchmove=null}function h(){g(),document.onkeydown=F,document.onmouseup=G}function i(){X.clearRect(0,0,ea.width,ea.height),X.fillStyle="#FFFFFF",X.font="18px Audiowide",X.textAlign="center",null!==questions&&questions.length>0?(X.fillText(M.util.get_string("spacetostart","mod_quizgame"),ea.width/2,ea.height/2),h()):X.fillText(M.util.get_string("emptyquiz","mod_quizgame"),ea.width/2,ea.height/2)}function j(a){Q(questions),ba?m():(_.forEach(function(a){var b=new Image;b.src=a,b.onload=function(){aa++,aa>=_.length&&l()}}),ba=!0)}function k(){h()}function l(){ca=!0,clearInterval(V),V=setInterval(function(){p(X,ea,$,Z,fa),q(ea,$,Z)},40),m()}function m(){Y=0,$=[],Z=[],da=-1,W=.5,ga=!1,ha=!1,T=new t("pix/ship.png",0,0),T.x=ea.width/2,T.y=ea.height/2,$.push(T),U=new u("pix/planet.png",0,0),U.image.width=ea.width,U.image.height=ea.height,U.direction.y=1,U.movespeed.y=.7,Z.push(U),n(),document.onkeyup=I,document.onkeydown=H,document.onmouseup=K,document.onmousedown=J,document.onmousemove=L,document.ontouchstart=N,document.ontouchend=O,document.ontouchmove=P}function n(){da++,da>=questions.length&&(da=0,W*=1.3),fa=o(questions,da,ea)}function o(a,b,c){if(ia=[],ja=0,ka=0,"multichoice"==a[b].type)a[b].answers.forEach(function(a){var b=new w(Math.random()*c.width,-Math.random()*c.height/2,a.text,a.fraction);a.fraction<1&&(ia.push(b),a.fraction>0&&(ka+=a.fraction)),$.push(b)});else if("match"==a[b].type){var d=0,e=1/a[b].stems.length;ka+=1,a[b].stems.forEach(function(a){d++;var b=new x(Math.random()*c.width,-Math.random()*c.height/2,a.question,e,-d,!0),f=new x(Math.random()*c.width,-Math.random()*c.height/2,a.answer,e,d);ia.push(b),ia.push(f),$.push(b),$.push(f)})}return a[b].question}function p(a,b,c,d,e){a.clearRect(0,0,b.width,b.height);for(var f=0;f<d.length;f++)d[f].draw(a);for(f=0;f<c.length;f++)c[f].draw(a);T.alive?(a.fillStyle="#FFFFFF",a.font="18px Audiowide",a.textAlign="left",a.fillText(M.util.get_string("score","mod_quizgame",{score:Math.round(Y),lives:T.lives}),5,20),a.textAlign="center",a.fillText(e,b.width/2,20)):(a.fillStyle="#FFFFFF",a.font="18px Audiowide",a.textAlign="center",a.fillText(M.util.get_string("endofgame","mod_quizgame",Math.round(T.lastScore)),b.width/2,b.height/2))}function q(a,b,c){for(var d=0;3>d;d++)c.push(new A(a));for(d=0;d<c.length;d++)c[d].update(a),c[d].alive||(c.splice(d,1),d--);for(d=0;d<b.length;d++){b[d].update(a);for(var e=d+1;e<b.length;e++)B(b[d],b[e]);b[d].alive||(b.splice(d,1),d--)}}function r(a,b,c,d){this.left=a||0,this.top=b||0,this.width=c||0,this.height=d||0}function s(a,b,c){null!==a&&(this.image=this.loadImage(a)),this.x=b,this.y=c,this.velocity={x:0,y:0},this.direction={x:0,y:0},this.movespeed={x:5,y:3},this.alive=!0,this.decay=.7}function t(a,b,c){s.call(this,a,b,c),this.mouse={x:0,y:0},this.movespeed={x:6,y:4},this.lives=3,this.lastScore=0}function u(a,b,c){s.call(this,a,b,c)}function v(a,b,c,d,e){s.call(this,a,b,c),this.xspeed=W,this.yspeed=W*(2+Math.random())/4,this.movespeed.x=0,this.movespeed.y=0,this.direction.y=1,this.text=d,this.fraction=e,this.movementClock=0,this.shotFrequency=80,this.shotClock=(1+Math.random())*this.shotFrequency,this.level=da}function w(a,b,c,d){v.call(this,"pix/enemy.png",a,b,c,d)}function x(a,b,c,d,e,f){this.stem=f?!0:!1,this.stem?v.call(this,"pix/enemystem.png",a,b,c,d):v.call(this,"pix/enemychoice.png",a,b,c,d),this.pairid=e,this.shotFrequency=160,this.hightlighted=!1}function y(a,b,c,d){s.call(this,c?"pix/laser.png":"pix/enemylaser.png",a,b),this.direction.y=-1,this.friendly=c?1:0,this.laserSpeed=d||12}function z(a,b,c,d){s.call(this,null,a,b),this.width=2,this.height=2,this.velocity.x=c.x,this.velocity.y=c.y,this.aliveTime=0,this.colour=d,this.decay=1}function A(a){s.call(this,null,Math.random()*a.width,0),this.width=2,this.height=2,this.direction.y=1,this.movespeed.y=.2+Math.random()/2,this.aliveTime=0}function B(a,b){return a.alive&&b.alive&&(C(a,b)||C(b,a))}function C(a,b){return a instanceof y&&b instanceof t&&!a.friendly&&D(a,b)?(b.gotShot(a),a.die(),!0):a instanceof y&&b instanceof v&&a.friendly&&D(a,b)?(b.gotShot(a),!0):a instanceof t&&b instanceof v&&D(a,b)?(a.die(),!0):void 0}function D(a,b){var c=a.getRect(),d=b.getRect();return c.Intersect(d)}function E(a,b,c,d){for(var e=0;c>e;e++)Z.push(new z(a,b,{x:16*(Math.random()-.5),y:16*(Math.random()-.5)+3},d))}function F(a){-1!==[32,37,38,39,40].indexOf(a.keyCode)&&(a.preventDefault(),32===a.keyCode&&j(a))}function G(a){a.target===S&&j(a)}function H(a){-1!==[32,37,38,39,40].indexOf(a.keyCode)&&(a.preventDefault(),32===a.keyCode&&T.alive&&ma?T.Shoot():37===a.keyCode?T.direction.x=-1:38===a.keyCode?T.direction.y=-1:39===a.keyCode?T.direction.x=1:40===a.keyCode&&(T.direction.y=1))}function I(a){32===a.keyCode?ma=!0:-1!==[37,39].indexOf(a.keyCode)?T.direction.x=0:-1!==[38,40].indexOf(a.keyCode)&&(T.direction.y=0)}function J(a){if(a.target===S){var b=T.getRect().Contains({x:a.offsetX,y:a.offsetY});b&&T.alive&&T.Shoot(),ha||(T.mouse.x=a.offsetX,T.mouse.y=a.offsetY,ha=!0)}}function K(){T.direction.x=0,T.direction.y=0,ha=!1}function L(a){T.mouse.x=a.offsetX,T.mouse.y=a.offsetY}function N(a){a.target===S&&(T.alive&&a.touches.length>1?T.Shoot():(ga=!0,P(a)))}function O(a){0===a.touches.length&&(ga=!1),T.direction.x=0,T.direction.y=0}function P(a){T.mouse.x=a.touches[0].clientX,T.mouse.y=a.touches[0].clientY-T.image.height}function Q(a){for(var b,c,d=a.length;0!==d;)c=Math.floor(Math.random()*d),d-=1,b=a[d],a[d]=a[c],a[c]=b;return a}function R(){document.addEventListener&&(document.addEventListener("fullscreenchange",d,!1),document.addEventListener("MSFullscreenChange",d,!1),document.addEventListener("mozfullscreenchange",d,!1),document.addEventListener("webkitfullscreenchange",d,!1)),S=document.getElementById("mod_quizgame_game"),X=S.getContext("2d"),c(),V=setInterval(function(){i()},500)}var S,T,U,V,W,X,Y=0,Z=[],$=[],_=["pix/icon.gif","pix/planet.png","pix/ship.png","pix/enemy.png","pix/enemystem.png","pix/enemychoice.png","pix/enemystemselected.png","pix/enemychoiceselected.png","pix/laser.png","pix/enemylaser.png"],aa=0,ba=!1,ca=!1,da=-1,ea={x:0,y:0,width:0,height:0},fa="",ga=!1,ha=!1,ia=[],ja=0,ka=0,la=0;a("#mod_quizgame_fullscreen_button").on("click",function(){e()}),r.prototype.right=function(){return this.left+this.width},r.prototype.bottom=function(){return this.top+this.height},r.prototype.Contains=function(a){return a.x>this.left&&a.x<this.right()&&a.y>this.top&&a.y<this.bottom()},r.prototype.Intersect=function(a){var b=!(a.left>this.right()||a.right()<this.left||a.top>this.bottom()||a.bottom()<this.top);return b},s.prototype.loadImage=function(a){return this.image||(this.image=new Image),this.image.src=a,this.image},s.prototype.update=function(){this.velocity.x+=this.direction.x*this.movespeed.x,this.velocity.y+=this.direction.y*this.movespeed.y,this.x+=this.velocity.x,this.y+=this.velocity.y,this.velocity.y*=this.decay,this.velocity.x*=this.decay},s.prototype.draw=function(a){a.drawImage(this.image,this.x,this.y,this.image.width,this.image.height)},s.prototype.getRect=function(){return new r(this.x,this.y,this.image.width,this.image.height)},s.prototype.die=function(){this.alive=!1},t.prototype=Object.create(s.prototype),t.prototype.update=function(a){(ha||ga)&&(this.x<this.mouse.x-this.image.width?T.direction.x=1:this.x>this.mouse.x?T.direction.x=-1:T.direction.x=0,this.y<this.mouse.y-this.image.height?T.direction.y=1:this.y>this.mouse.y?T.direction.y=-1:T.direction.y=0),s.prototype.update.call(this,a),this.x<a.x-this.image.width?this.x=a.width:this.x>a.width&&(this.x=a.x-this.image.width),this.y<a.y?this.y=a.y:this.y>a.height-this.image.height&&(this.y=a.height-this.image.height)},t.prototype.Shoot=function(){b("laser"),$.unshift(new y(T.x,T.y,!0,24)),ma=!1},t.prototype.die=function(){s.prototype.die.call(this),b("explosion"),E(this.x+this.image.width/2,this.y+this.image.height/2,200,"#FFCC00"),this.lastScore=Y,k()},t.prototype.gotShot=function(a){a.alive&&(this.lives<=1?this.die():(this.lives--,E(this.x+this.image.width/2,this.y+this.image.height/2,100,"#FFCC00")))},u.prototype=Object.create(s.prototype),u.prototype.update=function(a){U.image.width=ea.width,U.image.height=ea.height,s.prototype.update.call(this,a)},v.prototype=Object.create(s.prototype),v.prototype.update=function(a){if(this.y<a.height/10||this.y>9*a.height/10?(this.movespeed.x=1*this.xspeed,this.movespeed.y=5*this.yspeed):(this.movespeed.x=this.xspeed,this.movespeed.y=this.yspeed),s.prototype.update.call(this,a),this.movementClock--,this.movementClock<=0&&(this.direction.x=Math.floor(3*Math.random())-1,this.movementClock=30*(2+Math.random())),this.shotClock-=W,this.shotClock<=0&&this.y<.6*a.height){b("enemylaser");var c=new y(this.x,this.y);c.direction.y=1,c.friendly=!1,$.unshift(c),this.shotClock=(1+Math.random())*this.shotFrequency}this.x<a.x-this.image.width?this.x=a.width:this.x>a.width&&(this.x=a.x-this.image.width),this.y>a.height+this.image.height&&this.alive&&(this.alive=!1,this.fraction>0&&(ka-=this.fraction,Y-=1e3*this.fraction),0>=ka&&this.level==da&&T.alive&&n())},v.prototype.draw=function(a){s.prototype.draw.call(this,a),a.fillStyle="#FFFFFF",a.font="15px Audiowide",a.textAlign="center",a.fillText(this.text,this.x+this.image.width/2,this.y-5)},v.prototype.die=function(){s.prototype.die.call(this),E(this.x+this.image.width,this.y+this.image.height,50+150*this.fraction,"#FF0000"),Y+=1e3*this.fraction,b("explosion")},v.prototype.gotShot=function(a){},w.prototype=Object.create(v.prototype),w.prototype.die=function(){v.prototype.die.call(this),this.fraction>0&&(ka-=this.fraction),(this.fraction>=1||this.fraction>0&&0>=ka)&&(ia.forEach(function(a){a.alive&&a.die()}),ia=[],n())},w.prototype.gotShot=function(a){this.fraction>0?(a.die(),this.die()):(Y+=600*(this.fraction-.5),a.deflect())},x.prototype=Object.create(v.prototype),x.prototype.die=function(){v.prototype.die.call(this)},x.prototype.gotShot=function(a){if(a.alive&&this.alive)if(ja==-this.pairid){a.die(),this.die();var b=0;ia.forEach(function(a){a.pairid==ja&&a.die(),a.alive&&b++}),0>=b&&n()}else ja==this.pairid?a.deflect():(a.die(),this.hightlight(),ja=this.pairid)},x.prototype.hightlight=function(){ia.forEach(function(a){a.unhightlight()}),this.stem?this.loadImage("pix/enemystemselected.png"):this.loadImage("pix/enemychoiceselected.png"),this.hightlighted=!0},x.prototype.unhightlight=function(){this.hightlighted&&(this.stem?this.loadImage("pix/enemystem.png"):this.loadImage("pix/enemychoice.png")),this.hightlighted=!1},y.prototype=Object.create(s.prototype),y.prototype.update=function(a){s.prototype.update.call(this,a),(this.x<a.x-this.image.width||this.x>a.width||this.y<a.y-this.image.height||this.y>a.height)&&(this.alive=!1),this.velocity.y=this.laserSpeed*this.direction.y},y.prototype.deflect=function(){this.image=this.loadImage("pix/enemylaser.png"),this.direction.y*=-1,this.friendly=!this.friendly,b("deflect")},z.prototype=Object.create(s.prototype),z.prototype.update=function(a){s.prototype.update.call(this,a),(this.x<a.x-this.width||this.x>a.width||this.y<a.y-this.height||this.y>a.height)&&(this.alive=!1),this.aliveTime++,this.aliveTime>15*Math.random()+5&&(this.alive=!1)},z.prototype.getRect=function(){return new r(this.x,this.y,this.width,this.height)},z.prototype.draw=function(a){a.fillStyle=this.colour,a.fillRect(this.x,this.y,this.width,this.height),a.stroke()},A.prototype=Object.create(s.prototype),A.prototype.update=function(a){s.prototype.update.call(this,a),this.y>a.height&&(this.alive=!1)},A.prototype.draw=function(a){a.fillStyle="#9999AA",a.fillRect(this.x,this.y,this.width,this.height),a.stroke()};var ma=!0;return{init:R}});