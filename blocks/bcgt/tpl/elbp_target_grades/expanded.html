<?php if(!defined('ELBP')) exit; ?>

<br><br>

<div id="elbp_target_grades_content">
    
    <?php if($courses): ?>
    
    <table class="elbp_target_grades_table">
        
        <tr style="background-color:<?= $obj->getHeaderBackgroundColour() ?>;color:<?= $obj->getHeaderFontColour() ?>">
            <th><?= $string['course'] ?></th>
            <th><?= get_string('qualification', 'block_bcgt') ?></th>
            <th><?= get_string('asptargetgrade', 'block_bcgt') ?></th>
            
            <?php if (elbp_has_capability('block/bcgt:editasptargetgrade', $access)): ?>
                <th></th>
            <?php endif; ?>
        </tr>
        
        <?php foreach($courses as $course): ?>
        <tr id="course_row_<?= $course->id ?>_<?= $course->qualid ?>">
            <td><?= $course->fullname ?></td>
            <td><?= (!is_null($course->qual) && $course->qual) ? $course->qual->get_display_name() : '-'; ?></td>
            <td>
                
                <?php if (elbp_has_capability('block/bcgt:editasptargetgrade', $access)): ?>
                <div id="course_<?= $course->id ?>_<?= $course->qualid ?>_edit" style="display:none;">
                    <select id="aspirational_<?= $course->id ?>_<?= $course->qualid ?>" onchange="update_on_select(<?= $course->id ?>, <?= $course->qualid ?>, this);return false;">
                        <option value=""><?= $string['pleaseselect'] ?></option>
                        <?php if($course->possibleGrades): ?>
                            <?php foreach($course->possibleGrades as $grade): ?>
                                <option value="<?= $grade['location'] ?>:<?= $grade['id'] ?>:<?= $grade['grade'] ?>" <?= (isset($course->aspirationalGrade) && isset($course->aspirationalGrade->grade) && $course->aspirationalGrade->grade == $grade['grade']) ? 'selected' : ''; ?> ><?= $grade['grade'] ?></option>
                            <?php endforeach; ?>
                        <?php endif; ?>
                        <option value="OTHER"><?= $string['other'] ?></option>
                    </select>
                    
                    <div id="aspirational_freetext_<?= $course->id ?>_<?= $course->qualid ?>" style="display:none;">
                        <br>
                        <input type="text" id="aspirational_custom_<?= $course->id ?>_<?= $course->qualid ?>" placeholder="<?= $string['grade'] ?>" />
                    </div>
                    
                </div>
                <?php endif; ?>
                
                <div id="course_<?= $course->id ?>_<?= $course->qualid ?>_view">
                    
                    <div id="aspirational_info_<?= $course->id ?>_<?= $course->qualid ?>">
                        <?php if (isset($course->aspirationalGrade) && isset($course->aspirationalGrade->grade)): ?>
                            <h3><?= $course->aspirationalGrade->grade ?></h3>
                            <small><?= $string['setby'] ?> <?= fullname($course->aspirationalGrade->setby) ?></small>
                        <?php else: ?>
                            -
                        <?php endif; ?>
                    </div>

                </div>
                
               
            </td>
            
            
            
            <?php if (elbp_has_capability('block/bcgt:editasptargetgrade', $access)): ?>
                <td>
                    <div id="button_<?= $course->id ?>_<?= $course->qualid ?>_save" style="display:none;">
                        <button class="elbp_b" onclick="save_targets(<?= $course->id ?>, '<?= $course->qualid ?>');return false;"><?= $string['save'] ?></button>
                    </div>
                    <div id="button_<?= $course->id ?>_<?= $course->qualid ?>_edit">
                        <button class="elbp_b" onclick="load_edit(<?= $course->id ?>, '<?= $course->qualid ?>');return false;"><?= $string['edit'] ?></button>
                    </div>
                    <div id="button_<?= $course->id ?>_<?= $course->qualid ?>_loading" style="display:none;">
                        <img src="<?= $CFG->wwwroot ?>/blocks/elbp/pix/loader.gif" alt="<?= $string['loading'] ?>" />
                    </div>
                </td>
            <?php endif; ?>
        </tr>
        <?php endforeach; ?>
        
        
    </table>
    
    <?php else: ?>
        <p class='c'><?= $string['noresults'] ?></p>
    <?php endif; ?>
    
</div>

<script>
    
    
    function load_edit(courseID, qualID){
        
        $('#course_'+courseID+'_'+qualID+'_view').hide();
        $('#course_'+courseID+'_'+qualID+'_edit').show();
        $('#button_'+courseID+'_'+qualID+'_edit').hide();
        $('#button_'+courseID+'_'+qualID+'_save').show();
        $('#button_'+courseID+'_'+qualID+'_loading').hide();
        
    }
    
    function close_edit(courseID, qualID){
        
        $('#course_'+courseID+'_'+qualID+'_view').show();
        $('#course_'+courseID+'_'+qualID+'_edit').hide();
        $('#button_'+courseID+'_'+qualID+'_edit').show();
        $('#button_'+courseID+'_'+qualID+'_save').hide();
        $('#button_'+courseID+'_'+qualID+'_loading').hide();
        
    }
    
    function update_on_select(courseID, qualID, select){
        
        var val = select.value;
        if (val == "OTHER"){
            $('#aspirational_freetext_'+courseID+'_'+qualID).show();
        }
        
    }
    
    function save_targets(courseID, qualID){
        
        var aspirational = $('#aspirational_'+courseID+'_'+qualID).val();
        var aspirationalcustom = $('#aspirational_custom_'+courseID+'_'+qualID).val();
        
        var params = { 
                        courseID: courseID, 
                        qualID: qualID,
                        studentID: <?= $obj->getStudentID() ?>, 
                        aspirationalgrade: aspirational,
                        aspirationalcustom: aspirationalcustom
                    };
        var data = { action: 'save', params: params };
        
        $('#button_'+courseID+'_'+qualID+'_save').hide();
        $('#button_'+courseID+'_'+qualID+'_loading').show();

        
        $.post('<?= $CFG->wwwroot ?>/blocks/bcgt/ajax/elbp_target_grades/ajax.php', data, function(d){
            close_edit(courseID, qualID);
            $('#course_row_'+courseID+'_'+qualID).effect( "highlight", {color: '#ccff66'}, 3000 );
            eval(d);
        });
        
        
    }
    
</script>